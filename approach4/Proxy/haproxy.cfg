#Global Configuration
# global
#     log stdout format raw local0 info
#     maxconn 20000
#     tune.ssl.default-dh-param 2048
    
#     # HTTP/2 tuning (affects frontends with h2)
#     tune.h2.initial-window-size 65535
#     tune.h2.max-concurrent-streams 500

# defaults
#     log     global
#     mode    http
#     option  httplog
#     option  dontlognull
#     option  forwardfor except 127.0.0.0/8
#     option  http-server-close
#     retries 3
#     timeout connect 10s
#     timeout client  1h
#     timeout server  1h
#     timeout tunnel  1h
#     timeout http-keep-alive 30s
#     timeout queue 30s

# listen stats
#     bind *:8404
#     mode http
#     stats enable
#     stats uri /
#     stats refresh 5s
#     stats show-legends
#     stats show-node
#     stats auth admin:admin123

# frontend https_front
#     bind *:443 ssl crt /etc/haproxy/certs/server.pem alpn h2,http/1.1
#     mode http
#     option httplog
#     default_backend app_backend

# frontend http_front
#     bind *:80
#     mode http
#     redirect scheme https code 301

# backend app_backend
#     mode http
#     balance roundrobin
#     option http-no-delay
#     option log-health-checks
#     http-reuse always
#     # HTTP/2 (h2c) health check
#     http-check send meth GET uri /health ver HTTP/2
#     http-check send hdr ":scheme" "http"
#     http-check send hdr ":authority" "haproxy-healthcheck"
#     http-check send hdr "user-agent" "haproxy-healthcheck"
#     http-check expect status 200
    
#     # Forward headers
#     http-request set-header X-Forwarded-Proto https if { ssl_fc }
#     http-request set-header X-Forwarded-For %[src]
    
#     # Add backend header
#     http-response add-header X-Backend-Server %s
    
#     # Node.js servers (HTTP/2 clear-text backend)
#     default-server proto h2
#     server app1 analytics-app1:4002 check inter 2s rise 2 fall 3 maxconn 2000
#     server app2 analytics-app2:4002 check inter 2s rise 2 fall 3 maxconn 2000
#     server app3 analytics-app3:4002 check inter 2s rise 2 fall 3 maxconn 2000

# global
#     log stdout format raw local0 info
#     maxconn 50000
#     tune.h2.max-concurrent-streams 1000

# defaults
#     mode http
#     log global
#     option httplog
#     option dontlognull
#     option redispatch
#     retries 3
#     timeout connect 5s
#     timeout client  30s
#     timeout server  30s
#     timeout tunnel  24h        # مهم جدًا للـ SSE
#     timeout http-keep-alive 10s

# # Stats page
# listen stats
#     bind *:8404
#     mode http
#     stats enable
#     stats uri /
#     stats refresh 5s
#     stats auth admin:admin123

# # HTTPS Frontend (h2load بيستخدم h2)
# frontend https_front
#     bind *:443 ssl crt /etc/haproxy/certs/server.pem alpn h2,http/1.1
#     mode http
#     default_backend app_backend

# frontend http_front
#     bind *:80
#     redirect scheme https code 301

# # Backend – أهم تغيير: نستخدم HTTP/1.1 مش h2
# backend app_backend
#     mode http
#     balance roundrobin
#     option forwardfor

#     # Correct headers for Node.js apps
#     http-request set-header Host localhost
#     http-request set-header X-Forwarded-Proto https
#     http-request set-header X-Forwarded-Port 443

#     # Health check
#     http-check connect
#     http-check send meth GET uri /health
#     http-check expect status 200

#     # Backend servers
#     server app1 analytics-app1:4002 check inter 3s rise 2 fall 3 maxconn 5000
#     server app2 analytics-app2:4002 check inter 3s rise 2 fall 3 maxconn 5000
#     server app3 analytics-app3:4002 check inter 3s rise 2 fall 3 maxconn 5000


# =========================
# Global Configuration
# =========================
# global
#     log stdout format raw local0 info
#     maxconn 20000
#     tune.ssl.default-dh-param 2048

#     # HTTP/2 tuning (affects frontends)
#     tune.h2.initial-window-size 65535
#     tune.h2.max-concurrent-streams 1000

# defaults
#     log     global
#     mode    http
#     option  httplog
#     option  dontlognull
#     option  forwardfor except 127.0.0.0/8
#     option  http-server-close
#     retries 3
#     timeout connect 10s
#     timeout client  1h
#     timeout server  1h
#     timeout tunnel  24h        # مهم جدًا للـ SSE
#     timeout http-keep-alive 30s
#     timeout queue 30s

# # =========================
# # Stats Page
# # =========================
# listen stats
#     bind *:8404
#     mode http
#     stats enable
#     stats uri /
#     stats refresh 5s
#     stats show-legends
#     stats show-node
#     stats auth admin:admin123

# # =========================
# # Frontends
# # =========================
# frontend https_front
#     bind *:443 ssl crt /etc/haproxy/certs/server.pem alpn h2,http/1.1
#     mode http
#     option httplog
#     default_backend app_backend

# frontend http_front
#     bind *:80
#     mode http
#     redirect scheme https code 301

# # =========================
# # Backend - Node.js apps (HTTP/1.1)
# # =========================
# backend app_backend
#     mode http
#     balance roundrobin
#     option forwardfor

#     # Correct headers for Node.js apps
#     http-request set-header Host localhost
#     http-request set-header X-Forwarded-Proto https
#     http-request set-header X-Forwarded-Port 443

#     # Simple health check
#     http-check connect
#     http-check send meth GET uri /health
#     http-check expect status 200

#     # Backend servers
#     server app1 analytics-app1:4002 check inter 3s rise 2 fall 3 maxconn 5000
#     server app2 analytics-app2:4002 check inter 3s rise 2 fall 3 maxconn 5000
#     server app3 analytics-app3:4002 check inter 3s rise 2 fall 3 maxconn 5000

global
    log stdout format raw local0 info
    maxconn 40000

    # HTTP/2 sane defaults
    tune.h2.max-concurrent-streams 100
    tune.h2.initial-window-size 65535

defaults
    mode http
    log global
    option httplog
    option dontlognull
    retries 3
    option redispatch

    # Timeouts — balanced, prevent stuck connections
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    timeout http-keep-alive 5s
    timeout tunnel 24h   # for SSE only
    timeout queue 5s

# ==========================
# Stats
# ==========================
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 5s
    stats auth admin:admin123

# ==========================
# HTTP Frontend
# ==========================
frontend http_front
    bind *:80
    redirect scheme https code 301

# ==========================
# HTTPS Frontend (HTTP/2)
# ==========================
frontend https_front
    bind *:443 ssl crt /etc/haproxy/certs/server.pem alpn h2,http/1.1
    mode http
    default_backend app_backend

# ==========================
# Backend (HTTP/1.1 only)
# ==========================
backend app_backend
    mode http
    balance roundrobin
    option forwardfor

    # Fix Node.js host/origin issues
    http-request set-header Host localhost
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Port 443

    # Health check
    http-check connect
    http-check send meth GET uri /health
    http-check expect status 200

    # Backend nodes
    server app1 analytics-app1:4002 maxconn 4000 check inter 2s rise 2 fall 3
    server app2 analytics-app2:4002 maxconn 4000 check inter 2s rise 2 fall 3
    server app3 analytics-app3:4002 maxconn 4000 check inter 2s rise 2 fall 3

